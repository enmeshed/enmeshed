// Test whether we can reach a grpc server through local proxy
import { Protocols, ServerEnhancer, ClientEnhancer } from '@enmeshed/grpc'
grpc = require('@grpc/grpc-js')

unary(req) -/>
  console.log("server serving TestService.unary", req)
  if req.message == 'fail':
    throw new Error("failed call")
  else:
    { message: 'unary reply: ' + req.message}

it! 'should work', -/>
    protos = new Protocols()
    protos.setProtoPath(__dirname)
    protos.require('test')
    protos.load()

    server = new ServerEnhancer()
    server.addService(protos.service("TestService"), {
      unary
    })
    <- server.bind('0.0.0.0:40000')
    server.start()

    client = new ClientEnhancer(protos.client('TestService', '127.0.0.1:4001/grpc/service1'))
    resp <- client.unary({message: 'test message'})
    expect(resp.message).toBe("unary reply: test message")

    server.shutdown()
