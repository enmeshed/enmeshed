import { TestServer } from './testServer'
import { ClientEnhancer, Credentials } from '..'
cuid = require('cuid')

let protos, server

class InstrumentedClientEnhancer extends ClientEnhancer:
  requestWillBegin(ctx) ->
    ctx.id = cuid()
    console.log("request", ctx.id, "willBegin", ctx)

  requestDidEnd(ctx) ->
    console.log("request", ctx.id, "didEnd", ctx)

beforeAll! -/>
  try:
    now server = new TestServer()
    now protos = server.protos
    <- server.start(31339)
  catch err:
    console.error(err)

afterAll! -/>
  console.log("test.client.afterAll")
  <- server.stop()

makeClient() -/>
  c1 <- protos.client('TestService', '127.0.0.1:31339')
  new InstrumentedClientEnhancer(c1)

test! "unary", -/>
  client <- makeClient()
  resp <- client.unary({message: 'test message'})
  client.close()
  expect(resp.message).toBe("unary reply: test message")

test! "unary server error", -/>
  let err = null
  client <- makeClient()
  try:
    <- client.unary({message: 'fail'})
  catch xerr:
    now err = xerr
  client.close()
  expect(err.details).toBe('failed call')

test! "clientStream", -/>
  client <- makeClient()
  gen = () -*/>
    yield { message: "hello " }
    yield { message: "world" }

  resp <- client.clientStream(gen)
  client.close()
  expect(resp.message).toBe("stream concatenated: hello world")

test! 'clientStream client error', -/>
  client <- makeClient()
  gen = () -*/>
    yield { message: "hello" }
    throw new Error("client error")
    yield { message: "World" }

  try:
    resp <- client.clientStream(gen)
    expect(true).toBe(false)
  catch err:
    expect(err.message).toBe("client error")
  client.close()

test! 'clientStream server error', -/>
  client <- makeClient()
  gen = () -*/>
    yield { message: "hello" }
    yield { message: "fail" }
    yield { message: "world" }

  try:
    resp <- client.clientStream(gen)
    expect(true).toBe(false)
  catch err:
    expect(err.details).toBe("failed call")
  client.close()

test! "serverStream", -/>
  client <- makeClient()
  stream <- client.serverStream({ message: "hello world" })
  let str = ''
  for await (packet of stream): now str += packet.message
  expect(str).toBe('server stream echo: hello world')
  client.close()

test! "serverStream error", -/>
  client <- makeClient()
  stream <- client.serverStream({ message: "fail" })
  try:
    let str = ''
    for await (packet of stream): now str += packet.message
    expect(true).toBe(false)
  catch err:
    expect(err.details).toBe("failed call")
  client.close()
